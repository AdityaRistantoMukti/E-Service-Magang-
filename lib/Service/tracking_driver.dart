import 'package:azza_service/Beli/shop.dart';
import 'package:azza_service/Home/Home.dart';
import 'package:azza_service/Others/notifikasi.dart';
import 'package:azza_service/Profile/profile.dart';
import 'package:azza_service/Promo/promo.dart';
import 'package:azza_service/Service/Service.dart';
import 'package:azza_service/Service/detail_service_midtrans.dart';
import 'package:azza_service/api_services/api_service.dart';
import 'package:azza_service/api_services/unified_payment_service.dart';
import 'package:azza_service/Others/session_manager.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:latlong2/latlong.dart';
import 'package:google_fonts/google_fonts.dart';
import 'dart:async';
import 'dart:convert';
import 'dart:math';
import 'dart:io';
import 'package:http/http.dart' as http;
import 'package:intl/intl.dart';
import 'package:vector_math/vector_math.dart' as vector_math;
import 'package:image_picker/image_picker.dart';

const String mapStoreName = 'e_service_map_store';

// Custom Tween for LatLng animation
class LatLngTween extends Tween<LatLng> {
  LatLngTween({required LatLng begin, required LatLng end}) : super(begin: begin, end: end);

  @override
  LatLng lerp(double t) {
    final lat = begin!.latitude + (end!.latitude - begin!.latitude) * t;
    final lng = begin!.longitude + (end!.longitude - begin!.longitude) * t;
    return LatLng(lat, lng);
  }
}

class TrackingPage extends StatefulWidget {
  final String? queueCode; // trans_kode

  const TrackingPage({super.key, this.queueCode});

  @override
  State<TrackingPage> createState() => _TrackingPageState();
}

class _TrackingPageState extends State<TrackingPage> with TickerProviderStateMixin {
  int currentIndex = 0;

  // Driver location for status updates
  LatLng? _driverLocation;
  LatLng? _previousDriverLocation;
  String _driverIcon = 'motorcycle';

  // Animation
  AnimationController? _animationController;
  Animation<LatLng>? _driverAnimation;

  Timer? _locationPollingTimer;
  Timer? _statusPollingTimer;
  int _locationPollingRetryCount = 0;
  static const int _maxLocationRetries = 3;

  // Payment loading state
  bool _isPaymentProcessing = false;

  // Payment method selection
  String? _selectedPaymentMethod;

  // E-wallet selection
  String? selectedEwallet;

  // Payment proof
  File? _paymentProofImage;
  final ImagePicker _picker = ImagePicker();

  // Bank account details
  final Map<String, Map<String, String>> bankDetails = {
    'BCA': {
      'accountNumber': '1234567890',
      'accountName': 'PT Azza Service Indonesia',
      'bankName': 'BCA',
    },
    'BRI': {
      'accountNumber': '0987654321',
      'accountName': 'PT Azza Service Indonesia',
      'bankName': 'BRI',
    },
    'Mandiri': {
      'accountNumber': '1122334455',
      'accountName': 'PT Azza Service Indonesia',
      'bankName': 'Mandiri',
    },
    'BNI': {
      'accountNumber': '5566778899',
      'accountName': 'PT Azza Service Indonesia',
      'bankName': 'BNI',
    },
    'CIMB Niaga': {
      'accountNumber': '9988776655',
      'accountName': 'PT Azza Service Indonesia',
      'bankName': 'CIMB Niaga',
    },
  };

  // Timeline state
  List<_TimelineItem> _timeline = [];
  bool _isTimelineExpanded = false;
  String _currentStatus = 'waiting';
  DateTime? _createdAt;
  DateTime? _updatedAt;
  double? _totalCost; // Untuk menyimpan total biaya dari tindakan
  double? _subtotalTindakan; // Subtotal dari tdkn_subtot 

  // Service type inference
  String _inferredServiceType = 'delivery'; // 'delivery' or 'pickup'
  bool _hasConfirmedType = false;

  static const _collapsedCount = 7;

  @override
  void initState() {
    super.initState();
    _refreshStatus();
    _startStatusPolling();
    // Show confirmation dialog for pickup after initial load
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_inferredServiceType == 'pickup' && !_hasConfirmedType) {
        _showServiceTypeConfirmationDialog();
      }
    });
  }

  @override
  void dispose() {
    _stopLocationPolling();
    _statusPollingTimer?.cancel();
    _animationController?.dispose();
    super.dispose();
  }

  // ========================= Polling =========================

  void _startLocationPolling() {
    _locationPollingTimer = Timer.periodic(const Duration(seconds: 5), (timer) async {
      if (_shouldStopPolling()) {
        _stopLocationPolling();
        return;
      }

      if (widget.queueCode == null || widget.queueCode!.isEmpty) return;

      try {
        final locationData = await ApiService.getDriverLocation(widget.queueCode!);
        if (locationData != null &&
            locationData['latitude'] != null &&
            locationData['longitude'] != null) {
          final newLat = double.tryParse(locationData['latitude'].toString());
          final newLng = double.tryParse(locationData['longitude'].toString());
          final icon = locationData['icon'] ?? 'motorcycle';
          if (newLat != null && newLng != null) {
            final newLocation = LatLng(newLat, newLng);
            if (_driverLocation != newLocation) {
              print('üìç [TRACKING] Driver location changed from ${_driverLocation?.latitude ?? "null"},${_driverLocation?.longitude ?? "null"} to ${newLocation.latitude},${newLocation.longitude}');
              _previousDriverLocation = _driverLocation;
              _startDriverAnimation(newLocation);
            }
            if (mounted) {
              setState(() {
                _driverIcon = icon;
                _driverLocation = newLocation;
              });
            }
            _locationPollingRetryCount = 0;
          } else {
            // Location data exists but is invalid - this is an error
            _handleLocationPollingError('Invalid location data format: $locationData');
          }
        } else {
          // No location data available yet - this is normal, continue polling
          print('üìç [TRACKING] No location data available for ${widget.queueCode}, continuing to poll...');
          // Reset retry count since this is not an error
          _locationPollingRetryCount = 0;
        }
      } catch (e) {
        _handleLocationPollingError('API Error: $e');
      }
    });
  }

  void _stopLocationPolling() {
    _locationPollingTimer?.cancel();
    _locationPollingTimer = null;
    print('üìç Location polling stopped for queueCode: ${widget.queueCode}');
  }

  bool _shouldStopPolling() {
    final stopStatuses = ['completed', 'cancelled', 'cancel', 'failed', 'rejected', 'menunggu_verifikasi'];
    return stopStatuses.contains(_currentStatus.toLowerCase());
  }

  void _handleLocationPollingError(String error) {
    _locationPollingRetryCount++;
    print('‚ùå Location polling error (attempt $_locationPollingRetryCount/$_maxLocationRetries): $error');

    if (_locationPollingRetryCount >= _maxLocationRetries) {
      print('üö´ Max retries reached, stopping location polling');
      _stopLocationPolling();
    }
  }

  void _startStatusPolling() {
    _statusPollingTimer?.cancel();
    _statusPollingTimer = Timer.periodic(const Duration(seconds: 15), (timer) async {
      await _refreshStatus();
    });
  }

  // Ambil trans_status dari transaksi dan subtotal tindakan
  Future<void> _refreshStatus() async {
    if (widget.queueCode == null || widget.queueCode!.isEmpty) return;
    try {
      final detail = await ApiService.getOrderDetail(widget.queueCode!);
      if (detail == null) return;

      String status = (detail['trans_status'] ?? 'waiting').toString().toLowerCase().trim();
      status = _normalizeStatus(status);

      final createdAtStr = (detail['created_at'] ?? detail['trans_tgl'] ?? detail['createdAt'])?.toString();
      final updatedAtStr = (detail['updated_at'] ?? detail['updatedAt'] ?? createdAtStr)?.toString();
      final createdAt = DateTime.tryParse(createdAtStr ?? '');
      final updatedAt = DateTime.tryParse(updatedAtStr ?? '');

      // Infer service type: delivery if kry_kode exists (technician assigned), else pickup
      final kryKode = detail['kry_kode']?.toString();
      _inferredServiceType = (kryKode != null && kryKode.isNotEmpty) ? 'delivery' : 'pickup';

      // Ambil subtotal dari tindakan
      double subtotal = 0.0;
      try {
        final tindakanList = await ApiService.getTindakanByTransKode(widget.queueCode!);
        if (tindakanList != null && tindakanList.isNotEmpty) {
          for (var tindakan in tindakanList) {
            final tdknSubtot = tindakan['tdkn_subtot'];
            if (tdknSubtot != null) {
              subtotal += double.tryParse(tdknSubtot.toString()) ?? 0.0;
            }
          }
        }
      } catch (e) {
        print('Error getting tindakan: $e');
      }

      // Ambil trans_total dari detail
      final transTotal = double.tryParse(detail['trans_total']?.toString() ?? '0') ?? 0.0;

      if (mounted) {
        setState(() {
          _currentStatus = status;
          _createdAt = createdAt ?? DateTime.now().subtract(const Duration(hours: 2));
          _updatedAt = updatedAt ?? DateTime.now();
          _subtotalTindakan = subtotal;
          _totalCost = transTotal; // Set total cost dari trans_total
          _timeline = _buildTimelineFromCurrentStatus(_currentStatus, _createdAt!, _updatedAt!);
        });
      }

      _updateLocationPollingForStatus(status);
    } catch (e) {
      print('Error refreshing status: $e');
    }
  }

  void _updateLocationPollingForStatus(String status) {
    // For pickup services, never poll location since technician doesn't travel
    if (_inferredServiceType == 'pickup') {
      if (_locationPollingTimer != null) {
        print('üìç Stopping location polling for pickup service');
        _stopLocationPolling();
      }
      return;
    }

    final activeStatuses = ['enroute', 'arrived', 'waitingapproval', 'approved', 'waitingOrder', 'pickingparts', 'repairing'];
    final shouldPoll = activeStatuses.contains(status.toLowerCase());

    if (shouldPoll && _locationPollingTimer == null) {
      print('üìç Starting location polling for active status: $status');
      _startLocationPolling();
    } else if (!shouldPoll && _locationPollingTimer != null) {
      print('üìç Stopping location polling for inactive status: $status');
      _stopLocationPolling();
    } else if (shouldPoll && _locationPollingTimer != null) {
      print('üìç Location polling already active for status: $status');
    }
  }


  void _startDriverAnimation(LatLng newLocation) {
    _animationController?.dispose();
    _animationController = AnimationController(
      duration: const Duration(seconds: 2),
      vsync: this,
    );

    _driverAnimation = LatLngTween(
      begin: _previousDriverLocation ?? _driverLocation ?? newLocation,
      end: newLocation,
    ).animate(CurvedAnimation(
      parent: _animationController!,
      curve: Curves.easeInOut,
    ));

    _driverAnimation!.addListener(() {
      if (mounted) {
        setState(() {
          _driverLocation = _driverAnimation!.value;
        });
      }
    });

    _animationController!.forward();
  }

  // ========================= Timeline builder =========================

  final List<String> _orderedStatuses = const [
    'waiting',
    'accepted',
    'enroute',
    'arrived',
    'waitingapproval',
    'approved',
    'waitingOrder',
    'pickingparts',
    'repairing',
    'menunggu_verifikasi',
    'completed',
  ];

  final Map<String, List<String>> _statusByType = const {
    'delivery': [
      'waiting',
      'accepted',
      'enroute',
      'arrived',
      'waitingapproval',
      'approved',
      'waitingOrder',
      'pickingparts',
      'repairing',
      'menunggu_verifikasi',
      'completed',
    ],
    'pickup': [
      'itemSubmitted', // Pengecekan
      'waitingapproval',
      'waitingOrder',
      'repairing',
      'menunggu_verifikasi',
      'completed',
    ],
  };

  String _normalizeStatus(String s) {
    final ss = s.replaceAll(' ', '').replaceAll('_', '');
    switch (ss) {
      case 'pending':
        return 'waiting';
      case 'enroute':
      case 'enrute':
      case 'enrouted':
      case 'en_route':
        return 'enroute';
      case 'waitingapproval':
      case 'waitingapprovalstatus':
        return 'waitingapproval';
      case 'approved':
        return 'approved';
      case 'waitingorder':
        return 'waitingOrder';
      case 'pickingparts':
      case 'pickingpart':
      case 'picking_parts':
        return 'pickingparts';
      case 'itemsubmitted':
      case 'item_submitted':
        return 'itemSubmitted';
      case 'menunggu_verifikasi':
      case 'menunggu_verifikasi':
        return 'menunggu_verifikasi';
      default:
        return ss;
    }
  }

  _StatusMeta _statusMeta(String statusKey, [String serviceType = 'delivery']) {
    switch (statusKey.toLowerCase()) {
      case 'waiting':
        return _StatusMeta('Pesanan Dibuat', 'Pesanan dibuat dan menunggu konfirmasi teknisi.');
      case 'accepted':
        return _StatusMeta('Teknisi Ditugaskan', 'Teknisi sudah ditugaskan. Pesanan akan diproses.');
      case 'enroute':
        return serviceType == 'pickup'
          ? _StatusMeta('Menunggu Teknisi', 'Barang Anda sedang dipersiapkan untuk diperiksa teknisi.')
          : _StatusMeta('Teknisi Mengajukan Part', 'Teknisi dalam perjalanan menuju lokasi Anda.');
      case 'arrived':
        return serviceType == 'pickup'
          ? _StatusMeta('Barang Diterima', 'Barang Anda telah diterima dan sedang diperiksa teknisi.')
          : _StatusMeta('Sampai Lokasi', 'Teknisi telah tiba di lokasi Anda.');
      case 'itemsubmitted':
        return _StatusMeta('Barang Diterima & Dicek', 'Barang Anda telah diterima dan sedang dalam proses pengecekan.');
      case 'waitingapproval':
        return _StatusMeta('Mengkonfirmasi Ketersediaan Part', 'Temuan kerusakan menunggu persetujuan biaya untuk perbaikan.');
      case 'approved':
        return _StatusMeta('Part Tersedia', 'Admin telah menyetujui tindakan perbaikan.');
      case 'waitingorder':
      return serviceType == 'pickup'
            ? _StatusMeta('Menunggu Transaksi User', 'User Harus Melakukan Transaksi untuk ke tahap perbaikan')
            : _StatusMeta('Sedang dalam Pengajuan Part', 'Pesanan sedang dalam pengajuan part.');
      case 'pickingparts':
        return _StatusMeta('Teknisi Dalam Perjalanan Mambawa Part', 'Pesanan sedang dalam pengajuan part.');
      case 'repairing':
        return _StatusMeta('Sedang Dikerjakan', 'Perbaikan perangkat Anda sedang diproses.');
      case 'menunggu_verifikasi':
        return _StatusMeta('Menunggu Verifikasi', 'Bukti pembayaran sedang diverifikasi oleh tim kami.');
      case 'completed':
        return _StatusMeta('Selesai', 'Layanan selesai. Terima kasih telah menggunakan layanan kami.');
      default:
        return _StatusMeta('Status Tidak Dikenal', 'Sedang memuat informasi status.');
    }
  }

  List<DateTime?> _distributeTimes({
    required int activeIndex,
    required DateTime start,
    required DateTime end,
    required int total,
  }) {
    if (activeIndex <= 0) {
      return List.generate(total, (i) => i == 0 ? start : null);
    }
    if (!end.isAfter(start)) {
      return List.generate(total, (i) {
        if (i > activeIndex) return null;
        return start.add(Duration(minutes: 5 * i));
      });
    }
    final steps = activeIndex;
    final interval = end.difference(start) ~/ (steps);
    return List.generate(total, (i) {
      if (i > activeIndex) return null;
      return start.add(interval * i);
    });
  }

  List<_TimelineItem> _buildTimelineFromCurrentStatus(
      String currentStatus, DateTime createdAt, DateTime updatedAt) {
    final orderedStatuses = _statusByType[_inferredServiceType] ?? _orderedStatuses;
    final total = orderedStatuses.length;
    final activeIndex = orderedStatuses.indexOf(currentStatus);
    final validActiveIndex = activeIndex >= 0 ? activeIndex : 0;

    final times = _distributeTimes(
      activeIndex: validActiveIndex,
      start: createdAt,
      end: updatedAt,
      total: total,
    );

    final List<_TimelineItem> items = [];

    if (currentStatus == 'completed') {
      for (int i = 0; i <= validActiveIndex; i++) {
        final s = orderedStatuses[i];
        final meta = _statusMeta(s, _inferredServiceType);
        items.add(_TimelineItem(
          time: times[i],
          title: meta.title,
          description: meta.description,
          state: StepState.done,
        ));
      }
    } else if (currentStatus == 'waiting') {
      final currentMeta = _statusMeta('waiting', _inferredServiceType);
      items.add(_TimelineItem(
        time: times[0],
        title: currentMeta.title,
        description: currentMeta.description,
        state: StepState.progress,
      ));

      if (validActiveIndex + 1 < total) {
        final nextMeta = _statusMeta(orderedStatuses[1], _inferredServiceType);
        items.add(_TimelineItem(
          time: times[1],
          title: nextMeta.title,
          description: nextMeta.description,
          state: StepState.progress,
        ));
      }
    } else {
      for (int i = 0; i < validActiveIndex; i++) {
        final s = orderedStatuses[i];
        final meta = _statusMeta(s, _inferredServiceType);
        items.add(_TimelineItem(
          time: times[i],
          title: meta.title,
          description: meta.description,
          state: StepState.done,
        ));
      }

      final currentMeta = _statusMeta(orderedStatuses[validActiveIndex], _inferredServiceType);
      items.add(_TimelineItem(
        time: times[validActiveIndex],
        title: currentMeta.title,
        description: currentMeta.description,
        state: StepState.done,
      ));

      if (validActiveIndex + 1 < total) {
        final nextStatus = orderedStatuses[validActiveIndex + 1];
        final nextMeta = _statusMeta(nextStatus, _inferredServiceType);
        items.add(_TimelineItem(
          time: times[validActiveIndex + 1],
          title: nextMeta.title,
          description: nextMeta.description,
          state: StepState.progress,
        ));
      }
    }

    return items;
  }

  String _fmt(DateTime? dt) => dt == null ? '‚Äî' : DateFormat('dd-MM-yyyy HH:mm').format(dt);

  IconData _getDriverIcon(String iconName) {
    switch (iconName.toLowerCase()) {
      case 'car':
        return Icons.directions_car;
      case 'truck':
        return Icons.local_shipping;
      case 'van':
        return Icons.airport_shuttle;
      case 'motorcycle':
      default:
        return Icons.motorcycle;
    }
  }

  IconData _getStatusIcon(String status) {
    switch (status.toLowerCase()) {
      case 'waiting':
        return Icons.hourglass_empty;
      case 'accepted':
        return Icons.check_circle;
      case 'enroute':
        return Icons.directions_car;
      case 'arrived':
        return Icons.location_on;
      case 'waitingapproval':
        return Icons.hourglass_empty;
      case 'approved':
        return Icons.verified;
      case 'waitingorder':
        return Icons.shopping_cart;
      case 'pickingparts':
        return Icons.local_shipping;
      case 'repairing':
        return Icons.engineering;
      case 'menunggu_verifikasi':
        return Icons.hourglass_empty;
      case 'completed':
        return Icons.check_circle;
      default:
        return Icons.info;
    }
  }

  Widget _buildPaymentMethodOption(String title, String subtitle, IconData icon, bool isSelected, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          border: Border.all(
            color: isSelected ? const Color(0xFF0041c3) : Colors.grey.shade300,
            width: isSelected ? 2 : 1,
          ),
          borderRadius: BorderRadius.circular(8),
          color: isSelected ? const Color(0xFF0041c3).withOpacity(0.1) : Colors.white,
        ),
        child: Row(
          children: [
            Icon(
              icon,
              color: isSelected ? const Color(0xFF0041c3) : Colors.grey,
              size: 24,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                      color: isSelected ? const Color(0xFF0041c3) : Colors.black87,
                    ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ),
            if (isSelected)
              const Icon(
                Icons.check_circle,
                color: Color(0xFF0041c3),
                size: 20,
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildComingSoonPaymentOption(String title, String subtitle, IconData icon) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        border: Border.all(color: Colors.grey.shade300),
        borderRadius: BorderRadius.circular(8),
        color: Colors.grey.shade50,
      ),
      child: Row(
        children: [
          Icon(
            icon,
            color: Colors.grey.shade400,
            size: 24,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(
                      title,
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Colors.grey.shade500,
                      ),
                    ),
                    const SizedBox(width: 8),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                      decoration: BoxDecoration(
                        color: Colors.orange.shade100,
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Text(
                        'Coming Soon',
                        style: TextStyle(
                          fontSize: 10,
                          fontWeight: FontWeight.w600,
                          color: Colors.orange.shade700,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 2),
                Text(
                  subtitle,
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey.shade400,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _showManualPaymentDialog(BuildContext context, double amount) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        title: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.blue[50],
                shape: BoxShape.circle,
              ),
              child: const Icon(
                Icons.qr_code,
                color: Colors.blue,
                size: 48,
              ),
            ),
            const SizedBox(height: 16),
            const Text(
              'Pembayaran Manual DP',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: Colors.black87,
              ),
            ),
          ],
        ),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Text(
                'Pilih metode pembayaran:',
                style: TextStyle(
                  fontSize: 14,
                  color: Colors.grey,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 20),

              // QRIS Option
              _buildManualPaymentOption(
                'QRIS',
                'Scan QR code untuk bayar',
                Icons.qr_code_2,
                () => _showQrisPayment(context, amount),
              ),

              const SizedBox(height: 12),

              // Bank Transfer Option
              _buildManualPaymentOption(
                'Transfer Bank',
                'Transfer ke rekening bank',
                Icons.account_balance,
                () => _showBankTransferPayment(context, amount),
              ),

              const SizedBox(height: 20),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.orange[50],
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: Colors.orange[200]!),
                ),
                child: const Text(
                  '‚ö†Ô∏è Pembayaran manual untuk testing saja. Dalam production akan menggunakan gateway pembayaran resmi.',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.orange,
                  ),
                  textAlign: TextAlign.center,
                ),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text(
              'Batal',
              style: TextStyle(color: Colors.grey),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildManualPaymentOption(String title, String subtitle, IconData icon, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          border: Border.all(color: Colors.grey.shade300),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Row(
          children: [
            Icon(icon, color: Colors.blue, size: 24),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                  Text(
                    subtitle,
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ),
            const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey),
          ],
        ),
      ),
    );
  }

  void _showQrisPayment(BuildContext context, double amount, {bool isCancel = false}) {
    Navigator.pop(context); // Close method selection dialog

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        elevation: 0,
        insetPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 24),
        child: Container(
          width: MediaQuery.of(context).size.width * 0.9,
          constraints: BoxConstraints(
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(24),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Header integrated with container
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 20),
                decoration: BoxDecoration(
                  color: Colors.green.shade50,
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
                  border: Border(
                    bottom: BorderSide(color: Colors.green.shade100, width: 1),
                  ),
                ),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        gradient: const LinearGradient(
                          colors: [Color(0xFF4CAF50), Color(0xFF2E7D32)],
                        ),
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.green.withOpacity(0.3),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: const Icon(
                        Icons.qr_code_2,
                        color: Colors.white,
                        size: 24,
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Pembayaran QRIS',
                            style: GoogleFonts.poppins(
                              fontSize: 18,
                              fontWeight: FontWeight.w700,
                              color: Colors.green.shade800,
                            ),
                          ),
                          Text(
                            'Scan & Bayar Cepat',
                            style: GoogleFonts.poppins(
                              fontSize: 12,
                              color: Colors.green.shade600,
                              fontWeight: FontWeight.w400,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),

              // Content
              Padding(
                padding: const EdgeInsets.all(24),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // QR Code Container with enhanced design
                    Container(
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            Colors.green.shade50,
                            Colors.green.shade100,
                          ],
                        ),
                        borderRadius: BorderRadius.circular(20),
                        border: Border.all(color: Colors.green.shade200, width: 2),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.green.withOpacity(0.1),
                            blurRadius: 12,
                            offset: const Offset(0, 4),
                          ),
                        ],
                      ),
                      child: Column(
                        children: [
                          Container(
                            width: 180,
                            height: 180,
                            decoration: BoxDecoration(
                              color: Colors.white,
                              borderRadius: BorderRadius.circular(16),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.1),
                                  blurRadius: 8,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                            child: ClipRRect(
                              borderRadius: BorderRadius.circular(16),
                              child: Image.asset(
                                'assets/image/my_qris.png',
                                fit: BoxFit.contain,
                                errorBuilder: (context, error, stackTrace) {
                                  return Container(
                                    color: Colors.grey.shade100,
                                    child: const Icon(
                                      Icons.qr_code_2,
                                      size: 80,
                                      color: Colors.grey,
                                    ),
                                  );
                                },
                              ),
                            ),
                          ),
                          const SizedBox(height: 16),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                            decoration: BoxDecoration(
                              color: Colors.green.shade600,
                              borderRadius: BorderRadius.circular(20),
                              border: Border.all(color: Colors.green.shade300),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(
                                  Icons.payments,
                                  size: 16,
                                  color: Colors.white,
                                ),
                                const SizedBox(width: 6),
                                Text(
                                  'Rp ${NumberFormat('#,###', 'id_ID').format(amount)}',
                                  style: GoogleFonts.poppins(
                                    fontSize: 18,
                                    fontWeight: FontWeight.w700,
                                    color: Colors.white,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 20),

                    // Instructions with better design
                    Container(
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            Colors.blue.shade50,
                            Colors.indigo.shade50,
                          ],
                        ),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.blue.shade200),
                      ),
                      child: Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.all(10),
                            decoration: BoxDecoration(
                              color: Colors.blue.shade100,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Icon(
                              Icons.smartphone,
                              color: Colors.blue.shade600,
                              size: 24,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Cara Pembayaran',
                                  style: GoogleFonts.poppins(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                    color: Colors.blue.shade800,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  'Buka aplikasi e-wallet Anda dan scan QR code di atas',
                                  style: GoogleFonts.poppins(
                                    fontSize: 13,
                                    color: Colors.blue.shade600,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),

              // Actions with enhanced design
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: Colors.grey[50],
                  borderRadius: const BorderRadius.vertical(bottom: Radius.circular(24)),
                ),
                child: Row(
                  children: [
                    Expanded(
                      child: Container(
                        height: 50,
                        decoration: BoxDecoration(
                          color: Colors.grey.shade100,
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.grey.shade300),
                        ),
                        child: TextButton(
                          onPressed: () => Navigator.pop(context),
                          style: TextButton.styleFrom(
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          child: Text(
                            'Batal',
                            style: GoogleFonts.poppins(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                              color: Colors.grey.shade700,
                            ),
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Container(
                        height: 50,
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [Color(0xFF4CAF50), Color(0xFF2E7D32)],
                          ),
                          borderRadius: BorderRadius.circular(12),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.green.withOpacity(0.4),
                              blurRadius: 12,
                              offset: const Offset(0, 4),
                            ),
                          ],
                        ),
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.pop(context);
                            _showPaymentProofDialog(context, amount, 'QRIS', isCancel: isCancel);
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.transparent,
                            shadowColor: Colors.transparent,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          child: Text(
                            'Upload Bukti',
                            style: GoogleFonts.poppins(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: Colors.white,
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showBankTransferPayment(BuildContext context, double amount, {bool isCancel = false}) {
    Navigator.pop(context); // Close method selection dialog

    String selectedBank = 'BCA'; // Default selection

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: const Text(
            'Transfer Bank Manual',
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Bank Selection Dropdown
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                  decoration: BoxDecoration(
                    border: Border.all(color: Colors.grey.shade300),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: DropdownButton<String>(
                    value: selectedBank,
                    isExpanded: true,
                    underline: const SizedBox(),
                    items: bankDetails.keys.map((String bank) {
                      return DropdownMenuItem<String>(
                        value: bank,
                        child: Text(bank),
                      );
                    }).toList(),
                    onChanged: (String? newValue) {
                      if (newValue != null) {
                        setState(() {
                          selectedBank = newValue;
                        });
                      }
                    },
                  ),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.blue[50],
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Column(
                    children: [
                      const Text(
                        'Rekening Tujuan:',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        '${selectedBank} - ${bankDetails[selectedBank]!['accountNumber']}',
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.blue,
                        ),
                      ),
                      Text(
                        'a.n. ${bankDetails[selectedBank]!['accountName']}',
                        style: const TextStyle(
                          fontSize: 12,
                          color: Colors.grey,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),
                Text(
                  'Nominal: Rp ${NumberFormat('#,###', 'id_ID').format(amount)}',
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Transfer tepat sesuai nominal di atas',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Batal'),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.pop(context);
                _showPaymentProofDialog(context, amount, 'Transfer Bank - $selectedBank', isCancel: isCancel);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.green,
              ),
              child: const Text(
                'Upload Bukti Pembayaran',
                style: TextStyle(color: Colors.white),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showEwalletPayment(BuildContext context, double amount, {bool isCancel = false}) {
    Navigator.pop(context); // Close method selection dialog

    String? selectedEwallet;

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
        builder: (context, setState) => AlertDialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          title: Text(
            selectedEwallet == null ? 'Pembayaran E-wallet' : 'Pembayaran $selectedEwallet',
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: selectedEwallet == null ? [
                const Text(
                  'Pilih aplikasi e-wallet:',
                  style: TextStyle(
                    fontSize: 14,
                    color: Colors.grey,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 16),
                _buildEwalletSelectionGrid(amount, (ewallet) {
                  setState(() => selectedEwallet = ewallet);
                }),
                const SizedBox(height: 16),
                Text(
                  'Nominal: Rp ${NumberFormat('#,###', 'id_ID').format(amount)}',
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Pilih e-wallet dan ikuti instruksi pembayaran',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey,
                  ),
                  textAlign: TextAlign.center,
                ),
              ] : [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.blue[50],
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Column(
                    children: [
                      Text(
                        'Kirim ke $selectedEwallet:',
                        style: const TextStyle(
                          fontSize: 12,
                          color: Colors.grey,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        _getDummyEwalletAccount(selectedEwallet!),
                        style: const TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.blue,
                        ),
                      ),
                      const Text(
                        'a.n. PT. Azzahra Computer',
                        style: const TextStyle(
                          fontSize: 12,
                          color: Colors.grey,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 16),
                Text(
                  'Nominal: Rp ${NumberFormat('#,###', 'id_ID').format(amount)}',
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Kirim tepat sesuai nominal di atas ke rekening tujuan',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey,
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Batal'),
            ),
            if (selectedEwallet != null) ...[
              TextButton(
                onPressed: () => setState(() => selectedEwallet = null),
                child: const Text('Kembali'),
              ),
              ElevatedButton(
                onPressed: () {
                  Navigator.pop(context);
                  _showPaymentProofDialog(context, amount, selectedEwallet!, isCancel: isCancel);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.green,
                ),
                child: const Text(
                  'Upload Bukti Pembayaran',
                  style: TextStyle(color: Colors.white),
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }

  void _showPaymentProofDialog(BuildContext context, double amount, String paymentMethod, {bool isCancel = false}) {
    _paymentProofImage = null; // Reset image

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => StatefulBuilder(
      builder: (context, setState) => Dialog(
        backgroundColor: Colors.transparent,
        elevation: 0,
        insetPadding: EdgeInsets.symmetric(
          horizontal: 20,
          vertical: MediaQuery.of(context).viewInsets.bottom > 0 ? 10 : 24,
        ),
        child: ConstrainedBox(
          constraints: BoxConstraints(
            maxHeight: MediaQuery.of(context).size.height * 0.85,
            maxWidth: MediaQuery.of(context).size.width * 0.9,
          ),
          child: Container(
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(24),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                // Header integrated with container
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  decoration: BoxDecoration(
                    color: Colors.orange.shade50,
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
                    border: Border(
                      bottom: BorderSide(color: Colors.orange.shade100, width: 1),
                    ),
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [Color(0xFFFFA726), Color(0xFFFF9800)],
                          ),
                          borderRadius: BorderRadius.circular(10),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.orange.withOpacity(0.3),
                              blurRadius: 6,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: const Icon(
                          Icons.receipt_long,
                          color: Colors.white,
                          size: 20,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Upload Bukti Pembayaran',
                              style: GoogleFonts.poppins(
                                fontSize: 16,
                                fontWeight: FontWeight.w700,
                                color: Colors.orange.shade800,
                              ),
                            ),
                            Text(
                              'Verifikasi Pembayaran',
                              style: GoogleFonts.poppins(
                                fontSize: 11,
                                color: Colors.orange.shade600,
                                fontWeight: FontWeight.w400,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),

                // Scrollable Content
                Flexible(
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        // Payment info card
                        Container(
                          padding: const EdgeInsets.all(14),
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              begin: Alignment.topLeft,
                              end: Alignment.bottomRight,
                              colors: [
                                Colors.blue.shade50,
                                Colors.indigo.shade50,
                              ],
                            ),
                            borderRadius: BorderRadius.circular(14),
                            border: Border.all(color: Colors.blue.shade200),
                          ),
                          child: Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(8),
                                decoration: BoxDecoration(
                                  color: Colors.blue.shade100,
                                  borderRadius: BorderRadius.circular(10),
                                ),
                                child: Icon(
                                  Icons.payments,
                                  color: Colors.blue.shade600,
                                  size: 20,
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Metode: $paymentMethod',
                                      style: GoogleFonts.poppins(
                                        fontSize: 13,
                                        fontWeight: FontWeight.w600,
                                        color: Colors.blue.shade800,
                                      ),
                                    ),
                                    Text(
                                      'Rp ${NumberFormat('#,###', 'id_ID').format(amount)}',
                                      style: GoogleFonts.poppins(
                                        fontSize: 15,
                                        fontWeight: FontWeight.w700,
                                        color: Colors.blue.shade900,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 16),

                        // Instructions
                        Container(
                          padding: const EdgeInsets.all(12),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade50,
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(color: Colors.grey.shade200),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.info_outline,
                                color: Colors.grey.shade600,
                                size: 18,
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: Text(
                                  'Upload foto bukti pembayaran yang jelas dan terbaca',
                                  style: GoogleFonts.poppins(
                                    fontSize: 12,
                                    color: Colors.grey.shade700,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 16),

                        // Image upload area with enhanced design
                        if (_paymentProofImage != null)
                          Container(
                            width: double.infinity,
                            height: 160,
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(14),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.1),
                                  blurRadius: 6,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                            child: ClipRRect(
                              borderRadius: BorderRadius.circular(14),
                              child: Image.file(
                                _paymentProofImage!,
                                fit: BoxFit.cover,
                              ),
                            ),
                          )
                        else
                          Container(
                            width: double.infinity,
                            height: 120,
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                begin: Alignment.topCenter,
                                end: Alignment.bottomCenter,
                                colors: [
                                  Colors.grey.shade50,
                                  Colors.grey.shade100,
                                ],
                              ),
                              borderRadius: BorderRadius.circular(14),
                              border: Border.all(color: Colors.grey.shade300, width: 2),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.grey.withOpacity(0.1),
                                  blurRadius: 6,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    color: Colors.white,
                                    shape: BoxShape.circle,
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.grey.withOpacity(0.2),
                                        blurRadius: 6,
                                        offset: const Offset(0, 2),
                                      ),
                                    ],
                                  ),
                                  child: Icon(
                                    Icons.cloud_upload,
                                    size: 24,
                                    color: Colors.grey.shade500,
                                  ),
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  "Belum ada bukti pembayaran",
                                  style: GoogleFonts.poppins(
                                    color: Colors.grey.shade600,
                                    fontSize: 12,
                                    fontWeight: FontWeight.w500,
                                  ),
                                ),
                              ],
                            ),
                          ),

                        const SizedBox(height: 16),

                        // Upload button with enhanced design
                        Container(
                          width: double.infinity,
                          height: 44,
                          decoration: BoxDecoration(
                            gradient: const LinearGradient(
                              colors: [Color(0xFF0041c3), Color(0xFF0066FF)],
                            ),
                            borderRadius: BorderRadius.circular(10),
                            boxShadow: [
                              BoxShadow(
                                color: const Color(0xFF0041c3).withOpacity(0.3),
                                blurRadius: 8,
                                offset: const Offset(0, 3),
                              ),
                            ],
                          ),
                          child: ElevatedButton.icon(
                            onPressed: () => _showImageSourceDialog(context, setState),
                            icon: const Icon(Icons.camera_alt, size: 18),
                            label: Text(
                              _paymentProofImage != null ? "Ganti Foto" : "Pilih Foto",
                              style: GoogleFonts.poppins(
                                fontSize: 13,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.transparent,
                              shadowColor: Colors.transparent,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(10),
                              ),
                            ),
                          ),
                        ),

                        const SizedBox(height: 10),

                        // Format info
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                          decoration: BoxDecoration(
                            color: Colors.amber.shade50,
                            borderRadius: BorderRadius.circular(16),
                            border: Border.all(color: Colors.amber.shade200),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(
                                Icons.warning_amber_rounded,
                                size: 14,
                                color: Colors.amber.shade600,
                              ),
                              const SizedBox(width: 4),
                              Text(
                                "Format: JPG, PNG ‚Ä¢ Maksimal 5MB",
                                style: GoogleFonts.poppins(
                                  fontSize: 11,
                                  color: Colors.amber.shade700,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 20),
                      ],
                    ),
                  ),
                ),

                // Actions with enhanced design
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  decoration: BoxDecoration(
                    color: Colors.grey[50],
                    borderRadius: const BorderRadius.vertical(bottom: Radius.circular(24)),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Container(
                          height: 44,
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(color: Colors.grey.shade300),
                          ),
                          child: TextButton(
                            onPressed: () => Navigator.pop(context),
                            style: TextButton.styleFrom(
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(10),
                              ),
                            ),
                            child: Text(
                              'Batal',
                              style: GoogleFonts.poppins(
                                fontSize: 14,
                                fontWeight: FontWeight.w600,
                                color: Colors.grey.shade700,
                              ),
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Container(
                          height: 44,
                          decoration: BoxDecoration(
                            gradient: _paymentProofImage != null
                                ? const LinearGradient(
                                    colors: [Color(0xFF4CAF50), Color(0xFF2E7D32)],
                                  )
                                : LinearGradient(
                                    colors: [Colors.grey.shade300, Colors.grey.shade400],
                                  ),
                            borderRadius: BorderRadius.circular(10),
                            boxShadow: _paymentProofImage != null
                                ? [
                                    BoxShadow(
                                      color: Colors.green.withOpacity(0.4),
                                      blurRadius: 8,
                                      offset: const Offset(0, 3),
                                    ),
                                  ]
                                : null,
                          ),
                          child: ElevatedButton(
                            onPressed: _paymentProofImage != null
                                ? () {
                                    Navigator.pop(context);
                                    _confirmManualPayment(context, amount, paymentMethod, isCancel: isCancel);
                                  }
                                : null,
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.transparent,
                              shadowColor: Colors.transparent,
                              disabledBackgroundColor: Colors.transparent,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(10),
                              ),
                            ),
                            child: Text(
                              'Konfirmasi',
                              style: GoogleFonts.poppins(
                                fontSize: 13,
                                fontWeight: FontWeight.w600,
                                color: _paymentProofImage != null ? Colors.white : Colors.grey.shade500,
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    ),
  );
  }

  Future<void> _pickImage(ImageSource source, StateSetter setState) async {
    try {
      final XFile? pickedFile = await _picker.pickImage(
        source: source,
        maxWidth: 1920,
        maxHeight: 1080,
        imageQuality: 85,
      );

      if (pickedFile != null) {
        setState(() {
          _paymentProofImage = File(pickedFile.path);
        });
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error picking image: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _showImageSourceDialog(BuildContext context, StateSetter setState) {
    showModalBottomSheet(
      context: context,
      builder: (BuildContext context) {
        return SafeArea(
          child: Wrap(
            children: [
              ListTile(
                leading: const Icon(Icons.camera_alt),
                title: const Text('Kamera'),
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.camera, setState);
                },
              ),
              ListTile(
                leading: const Icon(Icons.photo_library),
                title: const Text('Galeri'),
                onTap: () {
                  Navigator.pop(context);
                  _pickImage(ImageSource.gallery, setState);
                },
              ),
            ],
          ),
        );
      },
    );
  }



  String _getDummyEwalletAccount(String eWalletName) {
    switch (eWalletName) {
      case 'GoPay':
        return '081234567890';
      case 'OVO':
        return '081234567891';
      case 'DANA':
        return '081234567892';
      case 'LinkAja':
        return '081234567893';
      case 'ShopeePay':
        return '081234567894';
      default:
        return '081234567890';
    }
  }

  Widget _buildEwalletOption(String name, Color color, double amount, Function(String) onEwalletSelected) {
    return InkWell(
      onTap: () => onEwalletSelected(name),
      splashColor: color.withOpacity(0.3),
      borderRadius: BorderRadius.circular(8),
      child: Container(
        width: 80,
        height: 80,
        padding: const EdgeInsets.all(8),
        decoration: BoxDecoration(
          color: color.withOpacity(0.1),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: color.withOpacity(0.3)),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.account_balance_wallet, color: color, size: 24),
            const SizedBox(height: 4),
            Text(
              name,
              style: TextStyle(
                fontSize: 10,
                fontWeight: FontWeight.bold,
                color: color,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEwalletSelectionGrid(double amount, Function(String) onEwalletSelected) {
    return Container(
      width: double.infinity,
      child: Wrap(
        alignment: WrapAlignment.center,
        spacing: 8,
        runSpacing: 8,
        children: [
          _buildEwalletOption('GoPay', Colors.blue, amount, onEwalletSelected),
          _buildEwalletOption('OVO', Colors.purple, amount, onEwalletSelected),
          _buildEwalletOption('DANA', Colors.blue.shade800, amount, onEwalletSelected),
          _buildEwalletOption('LinkAja', Colors.orange, amount, onEwalletSelected),
          _buildEwalletOption('ShopeePay', Colors.red, amount, onEwalletSelected),
        ],
      ),
    );
  }

  void _confirmManualPayment(BuildContext context, double amount, String method, {bool isCancel = false}) {
    // Create fake order code for manual payment
    final fakeOrderCode = 'manual_${DateTime.now().millisecondsSinceEpoch}';

    // Show verification pending dialog
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        title: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.orange[50],
                shape: BoxShape.circle,
              ),
              child: const Icon(
                Icons.hourglass_empty,
                color: Colors.orange,
                size: 48,
              ),
            ),
            const SizedBox(height: 16),
            Text(
              isCancel ? 'Pembayaran Cancel Diterima!' : 'Bukti Pembayaran Diterima!',
              style: const TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: Colors.black87,
              ),
            ),
          ],
        ),
        content: Text(
          isCancel
              ? 'Biaya cancel sebesar Rp ${NumberFormat('#,###', 'id_ID').format(amount)} dengan metode $method telah diterima. Order akan dibatalkan setelah verifikasi.'
              : 'Bukti pembayaran sebesar Rp ${NumberFormat('#,###', 'id_ID').format(amount)} dengan metode $method telah diterima. Status akan berubah menjadi "Menunggu Verifikasi" dan akan diverifikasi dalam 1x24 jam.',
          textAlign: TextAlign.center,
          style: GoogleFonts.poppins(
            fontSize: 14,
            color: Colors.grey[700],
            height: 1.5,
          ),
        ),
        actionsAlignment: MainAxisAlignment.center,
        actions: [
          SizedBox(
            width: 120,
            child: ElevatedButton(
              onPressed: () {
                Navigator.pop(context); // Close dialog
                if (isCancel) {
                  // For cancel, go back to previous screen
                  Navigator.pop(context);
                } else {
                  // Update status to "menunggu_verifikasi"
                  _updateStatusToVerificationPending();
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange[700],
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                padding: const EdgeInsets.symmetric(vertical: 12),
                elevation: 0,
              ),
              child: Text(
                'OK',
                style: GoogleFonts.poppins(
                  fontWeight: FontWeight.w600,
                  fontSize: 15,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _onPaymentSuccess(String orderCode) {
    // Just refresh status without showing popup
    _refreshStatus();
  }

  void _updateStatusToVerificationPending() {
    if (mounted) {
      setState(() {
        _currentStatus = 'menunggu_verifikasi';
        _updatedAt = DateTime.now();
        _timeline = _buildTimelineFromCurrentStatus(_currentStatus, _createdAt!, _updatedAt!);
      });
    }
  }

  double _getProgressValue() {
    final orderedStatuses = _statusByType[_inferredServiceType] ?? _orderedStatuses;
    final currentIndex = orderedStatuses.indexOf(_currentStatus);
    if (currentIndex == -1) return 0.0;
    return ((currentIndex + 1) / orderedStatuses.length).clamp(0.0, 1.0);
  }

  List<_TimelineItem> _getCompletedStatuses() {
    return _timeline.where((item) => item.state == StepState.done).toList();
  }

  // ===== MODAL PEMBAYARAN DP =====
  void _showPaymentModal() {
    final TextEditingController dpAmountController = TextEditingController();

    // Hitung DP minimal (30% dari total)
    final double minDp = _totalCost != null ? _totalCost! * 0.3 : 0.0;
    final int maxDp = _totalCost != null ? (_totalCost! - 1).toInt() : 0;

    String? selectedPaymentMethod = _selectedPaymentMethod; // Initialize with current value
    String? selectedBank; // For bank transfer and e-wallet selection

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) {
          return Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [Color(0xFF0041c3), Color(0xFF0066FF)],
              ),
              borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
            ),
            constraints: BoxConstraints(
              maxHeight: MediaQuery.of(context).size.height * 0.85,
            ),
            child: Column(
              children: [
                // Handle bar with glow effect
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  width: 50,
                  height: 5,
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(3),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.white.withOpacity(0.2),
                        blurRadius: 8,
                        spreadRadius: 1,
                      ),
                    ],
                  ),
                ),

                Expanded(
                  child: Container(
                    margin: const EdgeInsets.only(top: 20),
                    decoration: const BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
                    ),
                    child: Padding(
                      padding: EdgeInsets.only(
                        bottom: MediaQuery.of(context).viewInsets.bottom,
                        left: 20,
                        right: 20,
                        top: 20,
                      ),
                      child: SingleChildScrollView(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Header with icon
                            Row(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    gradient: const LinearGradient(
                                      colors: [Color(0xFFFFA726), Color(0xFFFF9800)],
                                    ),
                                    borderRadius: BorderRadius.circular(15),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.orange.withOpacity(0.3),
                                        blurRadius: 10,
                                        offset: const Offset(0, 4),
                                      ),
                                    ],
                                  ),
                                  child: const Icon(
                                    Icons.payment,
                                    color: Colors.white,
                                    size: 28,
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        'Pembayaran DP',
                                        style: GoogleFonts.poppins(
                                          fontSize: 22,
                                          fontWeight: FontWeight.w700,
                                          color: Colors.black87,
                                        ),
                                      ),
                                      Text(
                                        'Down Payment Service',
                                        style: GoogleFonts.poppins(
                                          fontSize: 14,
                                          color: Colors.grey[600],
                                          fontWeight: FontWeight.w400,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),

                            const SizedBox(height: 24),

                            // Amount Summary Cards
                            Row(
                              children: [
                                Expanded(
                                  child: _buildAmountCard(
                                    'Total Biaya',
                                    _totalCost != null && _totalCost! > 0
                                        ? 'Rp ${NumberFormat('#,###', 'id_ID').format(_totalCost)}'
                                        : 'Rp 0',
                                    Colors.blue,
                                    Icons.receipt_long,
                                  ),
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: _buildAmountCard(
                                    'DP Minimal',
                                    _totalCost != null && _totalCost! > 0
                                        ? 'Rp ${NumberFormat('#,###', 'id_ID').format(minDp)}'
                                        : 'Rp 0',
                                    Colors.orange,
                                    Icons.account_balance_wallet,
                                  ),
                                ),
                              ],
                            ),

                            const SizedBox(height: 24),

                            // Payment Methods Section
                            Text(
                              'Pilih Metode Pembayaran',
                              style: GoogleFonts.poppins(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                                color: Colors.black87,
                              ),
                            ),
                            const SizedBox(height: 16),

                            // QRIS - Available
                            _buildModernPaymentOption(
                              "QRIS",
                              "Scan QR code untuk pembayaran cepat",
                              Icons.qr_code_2,
                              Colors.green,
                              selectedPaymentMethod == "QRIS",
                              () => setModalState(() => selectedPaymentMethod = "QRIS"),
                              available: true,
                            ),

                            const SizedBox(height: 12),

                            // Transfer Bank - Coming Soon
                            _buildModernPaymentOption(
                              "Transfer Bank",
                              "Transfer ke rekening bank",
                              Icons.account_balance,
                              Colors.grey,
                              false,
                              null,
                              available: false,
                            ),

                            const SizedBox(height: 12),

                            // E-wallet - Coming Soon
                            _buildModernPaymentOption(
                              "E-wallet",
                              "GoPay, OVO, Dana, LinkAja",
                              Icons.account_balance_wallet,
                              Colors.grey,
                              false,
                              null,
                              available: false,
                            ),

                            const SizedBox(height: 24),

                            // Amount Input Section
                            Container(
                              padding: const EdgeInsets.all(20),
                              decoration: BoxDecoration(
                                color: Colors.grey[50],
                                borderRadius: BorderRadius.circular(16),
                                border: Border.all(color: Colors.grey[200]!),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Nominal DP',
                                    style: GoogleFonts.poppins(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w600,
                                      color: Colors.black87,
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Text(
                                    'Masukkan jumlah DP yang ingin dibayar (minimal 30%)',
                                    style: GoogleFonts.poppins(
                                      fontSize: 12,
                                      color: Colors.grey[600],
                                    ),
                                  ),
                                  const SizedBox(height: 16),
                                  Container(
                                    decoration: BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(color: Colors.grey[300]!),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.grey.withOpacity(0.1),
                                          blurRadius: 8,
                                          offset: const Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: TextField(
                                      controller: dpAmountController,
                                      keyboardType: TextInputType.number,
                                      inputFormatters: [
                                        FilteringTextInputFormatter.digitsOnly,
                                        TextInputFormatter.withFunction((oldValue, newValue) {
                                          if (newValue.text.isEmpty) {
                                            return newValue;
                                          }
                                          final int? inputValue = int.tryParse(newValue.text);
                                          if (inputValue != null && _totalCost != null && inputValue >= _totalCost!) {
                                            return oldValue;
                                          }
                                          return newValue;
                                        }),
                                      ],
                                      decoration: InputDecoration(
                                        hintText: '0',
                                        hintStyle: GoogleFonts.poppins(
                                          fontSize: 18,
                                          color: Colors.grey[400],
                                        ),
                                        prefixText: 'Rp ',
                                        prefixStyle: GoogleFonts.poppins(
                                          fontSize: 18,
                                          fontWeight: FontWeight.w600,
                                          color: Colors.black87,
                                        ),
                                        border: InputBorder.none,
                                        contentPadding: const EdgeInsets.symmetric(
                                          horizontal: 20,
                                          vertical: 16,
                                        ),
                                      ),
                                      style: GoogleFonts.poppins(
                                        fontSize: 18,
                                        fontWeight: FontWeight.w600,
                                        color: Colors.black87,
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),

                            const SizedBox(height: 24),

                            // Pay Button
                            Container(
                              width: double.infinity,
                              height: 56,
                              decoration: BoxDecoration(
                                gradient: const LinearGradient(
                                  colors: [Color(0xFF0041c3), Color(0xFF0066FF)],
                                ),
                                borderRadius: BorderRadius.circular(16),
                                boxShadow: [
                                  BoxShadow(
                                    color: const Color(0xFF0041c3).withOpacity(0.3),
                                    blurRadius: 12,
                                    offset: const Offset(0, 4),
                                  ),
                                ],
                              ),
                              child: ElevatedButton.icon(
                                onPressed: () async {
                                  if (mounted) {
                                    setState(() => _selectedPaymentMethod = selectedPaymentMethod);
                                  }

                                  if (selectedPaymentMethod == null) {
                                    ScaffoldMessenger.of(context).showSnackBar(
                                      SnackBar(
                                        content: Text(
                                          'Mohon pilih metode pembayaran',
                                          style: GoogleFonts.poppins(),
                                        ),
                                        backgroundColor: Colors.red,
                                        behavior: SnackBarBehavior.floating,
                                        shape: RoundedRectangleBorder(
                                          borderRadius: BorderRadius.circular(10),
                                        ),
                                      ),
                                    );
                                    return;
                                  }

                                  final dpAmount = double.tryParse(
                                    dpAmountController.text.replaceAll(',', '').replaceAll('.', '')
                                  );

                                  if (dpAmount == null || dpAmount <= 0) {
                                    _showErrorDialog(
                                      'Input Tidak Valid',
                                      'Masukkan nominal DP yang valid untuk melanjutkan pembayaran.',
                                      Colors.red,
                                    );
                                    return;
                                  }

                                  if (dpAmount < minDp) {
                                    _showMinDpDialog(minDp);
                                    return;
                                  }

                                  Navigator.pop(context);

                                  final paymentAmount = dpAmount;
                                  if (selectedPaymentMethod == "QRIS") {
                                    _showQrisPayment(context, paymentAmount);
                                  }
                                },
                                icon: const Icon(Icons.payment, size: 24),
                                label: Text(
                                  'Bayar Sekarang',
                                  style: GoogleFonts.poppins(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: Colors.transparent,
                                  shadowColor: Colors.transparent,
                                  shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                ),
                              ),
                            ),

                            const SizedBox(height: 16),

                            // Security note
                            Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.green[50],
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: Colors.green[200]!),
                              ),
                              child: Row(
                                children: [
                                  Icon(
                                    Icons.security,
                                    color: Colors.green[600],
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Expanded(
                                    child: Text(
                                      'Pembayaran aman & terenkripsi dengan teknologi terkini',
                                      style: GoogleFonts.poppins(
                                        fontSize: 12,
                                        color: Colors.green[700],
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),

                            const SizedBox(height: 20),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildAmountCard(String title, String amount, Color color, IconData icon) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: color.withOpacity(0.2)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(icon, color: color, size: 20),
              const SizedBox(width: 8),
              Text(
                title,
                style: GoogleFonts.poppins(
                  fontSize: 12,
                  color: color.withOpacity(0.8),
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          Text(
            amount,
            style: GoogleFonts.poppins(
              fontSize: 16,
              fontWeight: FontWeight.w700,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildModernPaymentOption(
    String title,
    String subtitle,
    IconData icon,
    Color color,
    bool isSelected,
    VoidCallback? onTap, {
    required bool available,
  }) {
    return InkWell(
      onTap: available ? onTap : null,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: available ? (isSelected ? color.withOpacity(0.1) : Colors.white) : Colors.grey[50],
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: available
                ? (isSelected ? color : Colors.grey[200]!)
                : Colors.grey[300]!,
            width: isSelected ? 2 : 1,
          ),
          boxShadow: available && isSelected
              ? [
                  BoxShadow(
                    color: color.withOpacity(0.2),
                    blurRadius: 8,
                    offset: const Offset(0, 2),
                  ),
                ]
              : null,
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: available ? color.withOpacity(0.1) : Colors.grey[200],
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(
                icon,
                color: available ? color : Colors.grey[500],
                size: 24,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Text(
                        title,
                        style: GoogleFonts.poppins(
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                          color: available ? Colors.black87 : Colors.grey[500],
                        ),
                      ),
                      if (!available) ...[
                        const SizedBox(width: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.orange[100],
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            'Coming Soon',
                            style: GoogleFonts.poppins(
                              fontSize: 10,
                              fontWeight: FontWeight.w600,
                              color: Colors.orange[700],
                            ),
                          ),
                        ),
                      ],
                    ],
                  ),
                  const SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: GoogleFonts.poppins(
                      fontSize: 12,
                      color: available ? Colors.grey[600] : Colors.grey[400],
                    ),
                  ),
                ],
              ),
            ),
            if (available && isSelected)
              Container(
                padding: const EdgeInsets.all(4),
                decoration: BoxDecoration(
                  color: color,
                  shape: BoxShape.circle,
                ),
                child: const Icon(
                  Icons.check,
                  color: Colors.white,
                  size: 16,
                ),
              ),
          ],
        ),
      ),
    );
  }

  void _showErrorDialog(String title, String message, Color color) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
        ),
        backgroundColor: Colors.white,
        title: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: color.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.error_outline,
                color: color,
                size: 48,
              ),
            ),
            const SizedBox(height: 16),
            Text(
              title,
              style: GoogleFonts.poppins(
                fontWeight: FontWeight.w700,
                fontSize: 20,
                color: Colors.black87,
              ),
            ),
          ],
        ),
        content: Text(
          message,
          textAlign: TextAlign.center,
          style: GoogleFonts.poppins(
            fontSize: 14,
            color: Colors.grey[700],
            height: 1.5,
          ),
        ),
        actionsAlignment: MainAxisAlignment.center,
        actions: [
          SizedBox(
            width: 120,
            child: ElevatedButton(
              onPressed: () => Navigator.pop(context),
              style: ElevatedButton.styleFrom(
                backgroundColor: color,
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                padding: const EdgeInsets.symmetric(vertical: 12),
                elevation: 0,
              ),
              child: Text(
                'OK',
                style: GoogleFonts.poppins(
                  fontWeight: FontWeight.w600,
                  fontSize: 15,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _showMinDpDialog(double minDp) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(20),
        ),
        backgroundColor: Colors.white,
        title: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.orange.withOpacity(0.1),
              ),
              child: Icon(
                Icons.warning_amber_rounded,
                color: Colors.orange[700],
                size: 48,
              ),
            ),
            const SizedBox(height: 16),
            Text(
              'DP Kurang dari Minimal',
              style: GoogleFonts.poppins(
                fontWeight: FontWeight.w700,
                fontSize: 20,
                color: Colors.black87,
              ),
            ),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              'Pembayaran DP minimal adalah 30% dari total biaya perbaikan.',
              textAlign: TextAlign.center,
              style: GoogleFonts.poppins(
                fontSize: 14,
                color: Colors.grey[700],
                height: 1.5,
              ),
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.orange[50],
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.orange[200]!),
              ),
              child: Column(
                children: [
                  Text(
                    'DP Minimal',
                    style: GoogleFonts.poppins(
                      fontSize: 12,
                      color: Colors.grey[600],
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    'Rp ${NumberFormat('#,###', 'id_ID').format(minDp)}',
                    style: GoogleFonts.poppins(
                      fontSize: 22,
                      fontWeight: FontWeight.w700,
                      color: Colors.orange[900],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
        actionsAlignment: MainAxisAlignment.center,
        actions: [
          SizedBox(
            width: 120,
            child: ElevatedButton(
              onPressed: () => Navigator.pop(context),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.orange[700],
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                padding: const EdgeInsets.symmetric(vertical: 12),
                elevation: 0,
              ),
              child: Text(
                'Mengerti',
                style: GoogleFonts.poppins(
                  fontWeight: FontWeight.w600,
                  fontSize: 15,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }


  // Fungsi untuk memproses pembayaran DP
  Future<void> _processPayment(double amount, {bool isDp = true}) async {
    if (_isPaymentProcessing) return; // Prevent multiple calls

    if (mounted) {
      setState(() => _isPaymentProcessing = true);
    }

    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Center(
        child: Container(
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(12),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const CircularProgressIndicator(),
              const SizedBox(height: 16),
              Text(
                'Memproses pembayaran...',
                style: GoogleFonts.poppins(
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ),
      ),
    );

    try {
      // Gunakan UnifiedPaymentService untuk pembayaran DP
      await UnifiedPaymentService.startUnifiedPayment(
        context: context,
        paymentType: PaymentType.service,
        orderId: widget.queueCode!,
        amount: amount.toInt(),
        customerId: (await SessionManager.getCustomerId()) ?? '',
        customerName: 'Customer',
        customerEmail: 'customer@example.com',
        customerPhone: '081234567890',
        itemDetails: [
          {
            'id': isDp ? 'dp_payment' : 'full_payment',
            'price': amount.toInt(),
            'quantity': 1,
            'name': isDp ? 'Down Payment Service' : 'Full Payment Service',
          }
        ],
        onSuccess: (orderId) async {
          if (mounted) Navigator.pop(context); // Close loading

          if (mounted) {
            setState(() => _isPaymentProcessing = false);
          }

          // Just refresh status without showing popup
          _refreshStatus();
        },
        onFailure: (error) {
          if (mounted) Navigator.pop(context); // Close loading

          if (mounted) {
            setState(() => _isPaymentProcessing = false);
          }

          // Show error message
          if (mounted) ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                'Gagal memproses pembayaran: $error',
                style: GoogleFonts.poppins(),
              ),
              backgroundColor: Colors.red,
            ),
          );
        },
        serviceData: {
          'technicianCode': 'KRY001',
          'amount': amount,
          'paymentType': isDp ? 'dp' : 'full',  // Added paymentType
          'brand': '',
          'device': '',
          'serial': '',
          'complaint': isDp ? 'Down Payment' : 'Full Payment',
          'warrantyStatus': 'Tidak Ada Garansi',
        },
      );

    } catch (e) {
      if (mounted) Navigator.pop(context); // Close loading

      setState(() => _isPaymentProcessing = false);

      // Show error message
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'Gagal memproses pembayaran: $e',
            style: GoogleFonts.poppins(),
          ),
          backgroundColor: Colors.red,
        ),
      );
    }
  }
  Future<void> _processFullPayment() async {
    final fullAmount = _totalCost ?? 0.0;
    if (fullAmount <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'Total biaya tidak valid',
            style: GoogleFonts.poppins(),
          ),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(10),
          ),
        ),
      );
      return;
    }

    // Show modern payment method selection for full payment
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ConstrainedBox(
        constraints: BoxConstraints(
          maxHeight: MediaQuery.of(context).size.height * 0.8,
        ),
        child: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [Color(0xFF0041c3), Color(0xFF0066FF)],
            ),
            borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.only(top: 12),
                width: 50,
                height: 5,
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(3),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.white.withOpacity(0.2),
                      blurRadius: 8,
                      spreadRadius: 1,
                    ),
                  ],
                ),
              ),

              Flexible(
                child: Container(
                  margin: const EdgeInsets.only(top: 16),
                  decoration: const BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
                  ),
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        // Header
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(10),
                              decoration: BoxDecoration(
                                gradient: const LinearGradient(
                                  colors: [Color(0xFF2196F3), Color(0xFF1976D2)],
                                ),
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                    color: Colors.blue.withOpacity(0.3),
                                    blurRadius: 8,
                                    offset: const Offset(0, 3),
                                  ),
                                ],
                              ),
                              child: const Icon(
                                Icons.payments,
                                color: Colors.white,
                                size: 24,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Pembayaran Penuh',
                                    style: GoogleFonts.poppins(
                                      fontSize: 18,
                                      fontWeight: FontWeight.w700,
                                      color: Colors.black87,
                                    ),
                                  ),
                                  Text(
                                    'Full Payment Service',
                                    style: GoogleFonts.poppins(
                                      fontSize: 12,
                                      color: Colors.grey[600],
                                      fontWeight: FontWeight.w400,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),

                        const SizedBox(height: 16),

                        // Amount display
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            gradient: const LinearGradient(
                              colors: [Color(0xFFE3F2FD), Color(0xFFBBDEFB)],
                            ),
                            borderRadius: BorderRadius.circular(14),
                            border: Border.all(color: Colors.blue[200]!),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.receipt_long,
                                color: Colors.blue[700],
                                size: 20,
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Total Pembayaran',
                                      style: GoogleFonts.poppins(
                                        fontSize: 13,
                                        color: Colors.blue[700],
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                    Text(
                                      'Rp ${NumberFormat('#,###', 'id_ID').format(fullAmount)}',
                                      style: GoogleFonts.poppins(
                                        fontSize: 18,
                                        fontWeight: FontWeight.w700,
                                        color: Colors.blue[900],
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 20),

                        // Payment Methods
                        Text(
                          'Pilih Metode Pembayaran',
                          style: GoogleFonts.poppins(
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            color: Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 12),

                        // QRIS - Available
                        _buildModernPaymentOption(
                          "QRIS",
                          "Scan QR code untuk pembayaran cepat",
                          Icons.qr_code_2,
                          Colors.green,
                          false,
                          () {
                            Navigator.pop(context);
                            _showQrisPayment(context, fullAmount);
                          },
                          available: true,
                        ),

                        const SizedBox(height: 10),

                        // Transfer Bank - Coming Soon
                        _buildModernPaymentOption(
                          "Transfer Bank",
                          "Transfer ke rekening bank",
                          Icons.account_balance,
                          Colors.grey,
                          false,
                          null,
                          available: false,
                        ),

                        const SizedBox(height: 10),

                        // E-wallet - Coming Soon
                        _buildModernPaymentOption(
                          "E-wallet",
                          "GoPay, OVO, Dana, LinkAja",
                          Icons.account_balance_wallet,
                          Colors.grey,
                          false,
                          null,
                          available: false,
                        ),

                        const SizedBox(height: 16),

                        // Security note
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.green[50],
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(color: Colors.green[200]!),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.security,
                                color: Colors.green[600],
                                size: 18,
                              ),
                              const SizedBox(width: 6),
                              Expanded(
                                child: Text(
                                  'Pembayaran aman & terenkripsi',
                                  style: GoogleFonts.poppins(
                                    fontSize: 11,
                                    color: Colors.green[700],
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 20),
                      ],
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showCancelModal() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFD32F2F), Color(0xFFF44336)],
          ),
          borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
        ),
        constraints: BoxConstraints(
          maxHeight: MediaQuery.of(context).size.height * 0.6,
        ),
        child: Column(
          children: [
            // Handle bar
            Container(
              margin: const EdgeInsets.only(top: 12),
              width: 50,
              height: 5,
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.3),
                borderRadius: BorderRadius.circular(3),
                boxShadow: [
                  BoxShadow(
                    color: Colors.white.withOpacity(0.2),
                    blurRadius: 8,
                    spreadRadius: 1,
                  ),
                ],
              ),
            ),

            Expanded(
              child: Container(
                margin: const EdgeInsets.only(top: 20),
                decoration: const BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
                ),
                child: Padding(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Header
                      Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              gradient: const LinearGradient(
                                colors: [Color(0xFFF44336), Color(0xFFD32F2F)],
                              ),
                              borderRadius: BorderRadius.circular(15),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.red.withOpacity(0.3),
                                  blurRadius: 10,
                                  offset: const Offset(0, 4),
                                ),
                              ],
                            ),
                            child: const Icon(
                              Icons.cancel,
                              color: Colors.white,
                              size: 28,
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Batalkan Order',
                                  style: GoogleFonts.poppins(
                                    fontSize: 22,
                                    fontWeight: FontWeight.w700,
                                    color: Colors.black87,
                                  ),
                                ),
                                Text(
                                  'Cancel Order',
                                  style: GoogleFonts.poppins(
                                    fontSize: 14,
                                    color: Colors.grey[600],
                                    fontWeight: FontWeight.w400,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),

                      const SizedBox(height: 20),

                      // Cancel fee display
                      Container(
                        padding: const EdgeInsets.all(20),
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [Color(0xFFFFEBEE), Color(0xFFFFCDD2)],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(color: Colors.red[200]!),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.warning,
                              color: Colors.red[700],
                              size: 24,
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Biaya Pembatalan',
                                    style: GoogleFonts.poppins(
                                      fontSize: 14,
                                      color: Colors.red[700],
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                  Text(
                                    'Rp 50.000',
                                    style: GoogleFonts.poppins(
                                      fontSize: 20,
                                      fontWeight: FontWeight.w700,
                                      color: Colors.red[900],
                                    ),
                                  ),
                                  Text(
                                    'Biaya jasa pengecekan yang telah dilakukan',
                                    style: GoogleFonts.poppins(
                                      fontSize: 12,
                                      color: Colors.red[600],
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 24),

                      // Pay and Cancel Button
                      Container(
                        width: double.infinity,
                        height: 56,
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [Color(0xFFD32F2F), Color(0xFFF44336)],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.red.withOpacity(0.3),
                              blurRadius: 12,
                              offset: const Offset(0, 4),
                            ),
                          ],
                        ),
                        child: ElevatedButton.icon(
                          onPressed: () async {
                            Navigator.pop(context);
                            await _processCancelPayment();
                          },
                          icon: const Icon(Icons.payment, size: 24),
                          label: Text(
                            'Bayar & Batalkan Order',
                            style: GoogleFonts.poppins(
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.transparent,
                            shadowColor: Colors.transparent,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                        ),
                      ),

                      const SizedBox(height: 16),

                      // Warning note
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.orange[50],
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.orange[200]!),
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.info_outline,
                              color: Colors.orange[600],
                              size: 20,
                            ),
                            const SizedBox(width: 8),
                            Expanded(
                              child: Text(
                                'Tindakan ini tidak dapat dibatalkan',
                                style: GoogleFonts.poppins(
                                  fontSize: 12,
                                  color: Colors.orange[700],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _processCancelPayment() async {
    const cancelAmount = 50000; // Rp 50.000

    // Show modern payment method selection for cancel
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => ConstrainedBox(
        constraints: BoxConstraints(
          maxHeight: MediaQuery.of(context).size.height * 0.8,
        ),
        child: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [Color(0xFFD32F2F), Color(0xFFF44336)],
            ),
            borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Handle bar
              Container(
                margin: const EdgeInsets.only(top: 12),
                width: 50,
                height: 5,
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(3),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.white.withOpacity(0.2),
                      blurRadius: 8,
                      spreadRadius: 1,
                    ),
                  ],
                ),
              ),

              Flexible(
                child: Container(
                  margin: const EdgeInsets.only(top: 16),
                  decoration: const BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
                  ),
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        // Header
                        Row(
                          children: [
                            Container(
                              padding: const EdgeInsets.all(10),
                              decoration: BoxDecoration(
                                gradient: const LinearGradient(
                                  colors: [Color(0xFFF44336), Color(0xFFD32F2F)],
                                ),
                                borderRadius: BorderRadius.circular(12),
                                boxShadow: [
                                  BoxShadow(
                                    color: Colors.red.withOpacity(0.3),
                                    blurRadius: 8,
                                    offset: const Offset(0, 3),
                                  ),
                                ],
                              ),
                              child: const Icon(
                                Icons.cancel,
                                color: Colors.white,
                                size: 24,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Biaya Pembatalan',
                                    style: GoogleFonts.poppins(
                                      fontSize: 18,
                                      fontWeight: FontWeight.w700,
                                      color: Colors.black87,
                                    ),
                                  ),
                                  Text(
                                    'Cancel Order Fee',
                                    style: GoogleFonts.poppins(
                                      fontSize: 12,
                                      color: Colors.grey[600],
                                      fontWeight: FontWeight.w400,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),

                        const SizedBox(height: 16),

                        // Cancel fee display
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            gradient: const LinearGradient(
                              colors: [Color(0xFFFFEBEE), Color(0xFFFFCDD2)],
                            ),
                            borderRadius: BorderRadius.circular(14),
                            border: Border.all(color: Colors.red[200]!),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.warning,
                                color: Colors.red[700],
                                size: 20,
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Biaya Cancel Order',
                                      style: GoogleFonts.poppins(
                                        fontSize: 13,
                                        color: Colors.red[700],
                                        fontWeight: FontWeight.w500,
                                      ),
                                    ),
                                    Text(
                                      'Rp ${NumberFormat('#,###', 'id_ID').format(cancelAmount)}',
                                      style: GoogleFonts.poppins(
                                        fontSize: 18,
                                        fontWeight: FontWeight.w700,
                                        color: Colors.red[900],
                                      ),
                                    ),
                                    Text(
                                      'Biaya jasa pengecekan yang telah dilakukan',
                                      style: GoogleFonts.poppins(
                                        fontSize: 11,
                                        color: Colors.red[600],
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 20),

                        // Payment Methods
                        Text(
                          'Pilih Metode Pembayaran',
                          style: GoogleFonts.poppins(
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                            color: Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 12),

                        // QRIS - Available
                        _buildModernPaymentOption(
                          "QRIS",
                          "Scan QR code untuk pembayaran cepat",
                          Icons.qr_code_2,
                          Colors.green,
                          false,
                          () {
                            Navigator.pop(context);
                            _showQrisPayment(context, cancelAmount.toDouble(), isCancel: true);
                          },
                          available: true,
                        ),

                        const SizedBox(height: 10),

                        // Transfer Bank - Coming Soon
                        _buildModernPaymentOption(
                          "Transfer Bank",
                          "Transfer ke rekening bank",
                          Icons.account_balance,
                          Colors.grey,
                          false,
                          null,
                          available: false,
                        ),

                        const SizedBox(height: 10),

                        // E-wallet - Coming Soon
                        _buildModernPaymentOption(
                          "E-wallet",
                          "GoPay, OVO, Dana, LinkAja",
                          Icons.account_balance_wallet,
                          Colors.grey,
                          false,
                          null,
                          available: false,
                        ),

                        const SizedBox(height: 16),

                        // Warning note
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.orange[50],
                            borderRadius: BorderRadius.circular(10),
                            border: Border.all(color: Colors.orange[200]!),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.info_outline,
                                color: Colors.orange[600],
                                size: 18,
                              ),
                              const SizedBox(width: 6),
                              Expanded(
                                child: Text(
                                  'Pembayaran ini akan membatalkan order Anda',
                                  style: GoogleFonts.poppins(
                                    fontSize: 11,
                                    color: Colors.orange[700],
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 20),
                      ],
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showServiceTypeConfirmationDialog() {
    showDialog(
      context: context,
      barrierDismissible: false, // Prevent dismissing without choice
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        title: Text(
          'Konfirmasi Jenis Service',
          style: GoogleFonts.poppins(fontWeight: FontWeight.w600),
        ),
        content: Text(
          'Berdasarkan data order, ini terdeteksi sebagai service pickup (tidak ada teknisi yang ditugaskan). Apakah benar?',
          style: GoogleFonts.poppins(),
        ),
        actions: [
          TextButton(
            onPressed: () {
              _inferredServiceType = 'pickup';
              _hasConfirmedType = true;
              Navigator.pop(context);
              setState(() {}); // Refresh UI
            },
            child: Text(
              'Ya, Pickup',
              style: GoogleFonts.poppins(color: Colors.blue),
            ),
          ),
          TextButton(
            onPressed: () {
              _inferredServiceType = 'delivery';
              _hasConfirmedType = true;
              Navigator.pop(context);
              setState(() {}); // Refresh UI
            },
            child: Text(
              'Tidak, Delivery',
              style: GoogleFonts.poppins(color: Colors.grey),
            ),
          ),
        ],
      ),
    );
  }

  // ========================= UI =========================

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: const Color(0xFF0041c3),
        elevation: 0,
        title: Image.asset('assets/image/logo.png', width: 95, height: 30),
        actions: [
          IconButton(
            icon: const Icon(Icons.support_agent, color: Colors.white),
            onPressed: () {},
          ),
          IconButton(
            icon: const Icon(Icons.chat_bubble_outline, color: Colors.white),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const NotificationPage()),
              );
            },
          ),
        ],
      ),
      bottomNavigationBar: _bottomNavBar(),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [

            Text(
              'Status Order (${_inferredServiceType == 'delivery' ? 'Delivery' : 'Pickup'})',
              style: GoogleFonts.poppins(fontSize: 16, fontWeight: FontWeight.w600),
            ),

            if (_inferredServiceType == 'pickup') ...[
              const SizedBox(height: 8),
            ],

            const SizedBox(height: 8),

            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.blue.shade300),
              ),
              child: Row(
                children: [
                  Icon(
                    _getStatusIcon(_currentStatus),
                    color: Colors.blue.shade700,
                    size: 20,
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          _statusMeta(_currentStatus, _inferredServiceType).description,
                          style: GoogleFonts.poppins(
                            fontSize: 13,
                            color: Colors.blue.shade700,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                        const SizedBox(height: 4),
                        LinearProgressIndicator(
                          backgroundColor: Colors.blue.shade100,
                          valueColor: AlwaysStoppedAnimation<Color>(Colors.blue.shade600),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),

            const SizedBox(height: 16),

            if (_getCompletedStatuses().isNotEmpty) ...[
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 6,
                      offset: const Offset(0, 3),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Status yang Sudah Selesai', style: GoogleFonts.poppins(fontSize: 16, fontWeight: FontWeight.w600)),
                    const SizedBox(height: 8),
                    ..._getCompletedStatuses().map((item) => Padding(
                      padding: const EdgeInsets.only(bottom: 8),
                      child: Row(
                        children: [
                          Icon(Icons.check_circle, color: const Color(0xFF2E7D32), size: 16),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(item.title, style: GoogleFonts.poppins(fontSize: 14, fontWeight: FontWeight.w600, color: const Color(0xFF2E7D32))),
                                Text(_fmt(item.time), style: GoogleFonts.poppins(fontSize: 11, color: Colors.grey[600])),
                              ],
                            ),
                          ),
                        ],
                      ),
                    )).toList(),
                  ],
                ),
              ),
              const SizedBox(height: 16),
            ],

            // Button Bayar DP (muncul saat status approved atau waitingOrder)
            if (_currentStatus == 'approved' || _currentStatus == 'waitingOrder') ...[
              const SizedBox(height: 16),
              Column(
                children: [
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: _isPaymentProcessing ? null : _showPaymentModal,
                          icon: const Icon(Icons.payment, size: 20),
                          label: Text(
                            'Bayar DP',
                            style: GoogleFonts.poppins(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: _isPaymentProcessing ? Colors.grey : Colors.orange,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                            padding: const EdgeInsets.symmetric(vertical: 14),
                            elevation: 2,
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: ElevatedButton.icon(
                          onPressed: _isPaymentProcessing ? null : () => _processFullPayment(),
                          icon: const Icon(Icons.payment, size: 20),
                          label: Text(
                            'Bayar Keseluruhan',
                            style: GoogleFonts.poppins(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: _isPaymentProcessing ? Colors.grey : const Color(0xFF0041c3),
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                            padding: const EdgeInsets.symmetric(vertical: 14),
                            elevation: 2,
                          ),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8),
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: _isPaymentProcessing ? null : _showCancelModal,
                      icon: const Icon(Icons.cancel, size: 20),
                      label: Text(
                        'Cancel Order (Biaya Rp 50.000)',
                        style: GoogleFonts.poppins(
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: _isPaymentProcessing ? Colors.grey : Colors.red,
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        elevation: 2,
                      ),
                    ),
                  ),
                ],
              ),
            ],

            // Button Lanjutkan Pembayaran (muncul saat completed)
            if (_currentStatus == 'completed') ...[
              const SizedBox(height: 16),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => DetailServiceMidtransPage(
                          serviceType: 'repair',
                          nama: 'Customer',
                          status: _currentStatus,
                          jumlahBarang: 1,
                          items: const [],
                          alamat: 'Alamat Customer',
                        ),
                      ),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF0041c3),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    padding: const EdgeInsets.symmetric(vertical: 12),
                  ),
                  child: Text(
                    'Lanjutkan Pembayaran',
                    style: GoogleFonts.poppins(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
            ],

          ],
        ),
      ),
    );
  }


  Widget _buildTimelineSection() {
    if (_timeline.isEmpty) {
      return Padding(
        padding: const EdgeInsets.symmetric(vertical: 12),
        child: Text('Belum ada pembaruan status.', style: GoogleFonts.poppins(color: Colors.grey[700], fontSize: 13)),
      );
    }

    final items = List<_TimelineItem>.from(_timeline);

    List<Widget> children = [];
    for (int i = 0; i < items.length; i++) {
      final e = items[i];
      final isFirst = i == 0;
      final isLast = i == items.length - 1;

      children.add(_timelineRow(
        dateText: _fmt(e.time),
        title: e.title,
        description: e.description,
        state: e.state,
        showTopLine: !isFirst,
        showBottomLine: !isLast,
      ));
    }

    return Column(children: children);
  }

  Widget _timelineRow({
    required String dateText,
    required String title,
    required String description,
    required StepState state,
    required bool showTopLine,
    required bool showBottomLine,
  }) {
    final Color dotColor;
    final Widget dotChild;
    switch (state) {
      case StepState.done:
        dotColor = const Color(0xFF2E7D32);
        dotChild = const Icon(Icons.check, size: 10, color: Colors.white);
        break;
      case StepState.progress:
        dotColor = const Color(0xFFFF8F00);
        dotChild = const SizedBox.shrink();
        break;
      case StepState.pending:
        dotColor = Colors.grey.shade400;
        dotChild = const SizedBox.shrink();
        break;
    }

    final lineColor = Colors.grey.shade300;
    final titleColor = state == StepState.done
        ? const Color(0xFF2E7D32)
        : (state == StepState.progress ? const Color(0xFFFF8F00) : Colors.black87);

    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 24,
            child: Column(
              children: [
                if (showTopLine) Container(width: 2, height: 10, color: lineColor),
                Container(
                  width: 12,
                  height: 12,
                  decoration: BoxDecoration(color: dotColor, shape: BoxShape.circle),
                  child: dotChild,
                ),
                if (showBottomLine) Container(width: 2, height: 40, color: lineColor),
              ],
            ),
          ),
          const SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(dateText, style: GoogleFonts.poppins(fontSize: 11, color: Colors.grey[600])),
                const SizedBox(height: 2),
                Text(title, style: GoogleFonts.poppins(fontSize: 14, fontWeight: FontWeight.w600, color: titleColor)),
                const SizedBox(height: 2),
                Text(description, style: GoogleFonts.poppins(fontSize: 12, color: Colors.black87)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _bottomNavBar() {
    return BottomNavigationBar(
      currentIndex: currentIndex,
      onTap: (index) {
        if (index == 0) {
          Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const ServicePage()));
        } else if (index == 1) {
          Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const MarketplacePage()));
        } else if (index == 2) {
          Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const HomePage()));
        } else if (index == 3) {
          Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const TukarPoinPage()));
        } else if (index == 4) {
          Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const ProfilePage()));
        }
      },
      backgroundColor: const Color(0xFF0041c3),
      type: BottomNavigationBarType.fixed,
      selectedItemColor: Colors.white,
      unselectedItemColor: Colors.white70,
      showUnselectedLabels: true,
      selectedLabelStyle: GoogleFonts.poppins(fontSize: 12),
      unselectedLabelStyle: GoogleFonts.poppins(fontSize: 12),
      items: const [
        BottomNavigationBarItem(icon: Icon(Icons.build_circle_outlined), label: 'Service'),
        BottomNavigationBarItem(icon: Icon(Icons.shopping_cart_outlined), label: 'Beli'),
        BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
        BottomNavigationBarItem(icon: Icon(Icons.percent_outlined), label: 'Promo'),
        BottomNavigationBarItem(icon: Icon(Icons.person_outline), label: 'Profile'),
      ],
    );
  }
}

// ========================= Types util =========================

enum StepState { done, progress, pending }

class _TimelineItem {
  final DateTime? time;
  final String title;
  final String description;
  final StepState state;

  _TimelineItem({
    required this.time,
    required this.title,
    required this.description,
    required this.state,
  });
}

class _StatusMeta {
  final String title;
  final String description;
  _StatusMeta(this.title, this.description);
}
